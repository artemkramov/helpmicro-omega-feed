<link rel="import" href="../../lib/polymer/polymer.html">
<link rel="import" href="../../lib/iron-icons/iron-icons.html">

<dom-module id="onion-settings-bluetooth">
	<style>

		.main {
			background-color: #fff;
			border-color: transparent;
			padding: 4rem 2rem;
			margin-bottom: 0;
		}

		.container {
			width: 600px;
			margin: 0 auto;
		}

		.card {
			margin-top: 15px;
			background-color: #fff;
		}
			.card form > .form-group:last-child {
				margin-bottom: 0;
			}

		.loading{
			display: var(--loading-visibility);
			margin: var(--loading-visibility-margin);
			height: 100px;
			width: 100px;
			margin-left: 15px;
			-webkit-animation: rotation 1s infinite linear;
			-moz-animation: rotation 1s infinite linear;
			-o-animation: rotation 1s infinite linear;
			animation: rotation 1s infinite linear;
			border-left: 6px solid #EAF1FF;
			border-right: 6px solid #EAF1FF;
			border-bottom: 6px solid #EAF1FF;
			border-top: 6px solid #2450AD;
			border-radius: 100%
		}

		@-webkit-keyframes rotation {
			from{
				-webkit-transform: rotate(0deg)
			}
			to{
				-webkit-transform: rotate(359deg)
			}
		}

		@-moz-keyframes rotation {
			from{
				-moz-transform: rotate(0deg)
			}
			to{
				-moz-transform: rotate(359deg)
			}
		}

		@-o-keyframes rotation {
			from{
				-o-transform: rotate(0deg)
			}
			to{
				-o-transform: rotate(359deg)
			}
		}

		@keyframes rotation {
			from{
				transform: rotate(0deg)
			}
			to{
				transform: rotate(359deg)
			}
		}
		
		#enableBluetooth.onion-settings-bluetooth {
			margin-left: 20px;
		}
		
		.userInput {
			display: var(--user-input-visibility);
		}
		
		.bluetooth-message-box {
			display: var(--message-box-visibility);
		}
		
		
	</style>

	<template>
		<div class="container">
			<h4 class="card-title">Bluetooth Setup</h4>
			<div class="card card-block">
				<div id="configureLoading" class="loading"></div>
				<div id="globalControl" class="layout horizontal center">
					<div class="userInput">Bluetooth Enabled</div>
					<input type="checkbox" id="enableBluetooth" checked="{{enableBluetooth::change}}" autocomplete="off" class="userInput" />
					<div class="flex"></div><!-- space holder -->
				</div>
			</div>
		</div>
	</template>

	<script>
		'use strict';

		(function () {
			// var this = null;

			var created = function () {
				// this = this;
			};

			var ready = function () {
				onionConsole.getService('onion-session-provider', function (err, sessionProvider) {
                    this.sessionProvider = sessionProvider;
					onionConsole.getService('onion-bluetooth-provider', function (err, bluetoothProvider) {
						this.bluetoothProvider = bluetoothProvider;
					}.bind(this));
                }.bind(this));

			};

			var init = function () {
				this.getState();
			};
			
			var getState = function () {
				var self = this;
				this.onLoading(true);
				this.bluetoothProvider.getState(null)
				.then(function(result){
					this._setAttributeWithoutObserving("enableBluetooth", result.isPowerOn);
					this.onLoading(false);
				}.bind(this))
				.catch(function (err) {
					self.onLoading(false);
				});
			};
			
			var enableBluetoothChanged = function (newState) {
				if (this._observerLock) { return; }
				var self = this;
				if (confirm('Are you sure you want to change the Bluetooth state?')) {
					this.onLoading(true);
					var powerAlias = newState ? "on" : "off";
					this.bluetoothProvider.setAdapterPower(null, powerAlias)
					.then(function(result){
						this._setAttributeWithoutObserving("enableBluetooth", result.isPowerOn);
						this.onLoading(false);
					}.bind(this))
					.catch(function (err) {
						self._setAttributeWithoutObserving("enableBluetooth", !newState);
						onionConsole.sendNotification({
							title: 'Error',
							message: err
						})
						self.onLoading(false);
					});
				}
				else {
					this._setAttributeWithoutObserving("enableBluetooth", !newState);
				}
			}
			
			var _setAttributeWithoutObserving = function (attribute, value) {
				this._observerLock = true;
				this[attribute] = value;
				this._observerLock = false;
			}

			
			var onLoading = function (bLoading) {
				if (!bLoading) {
					this.customStyle['--loading-visibility'] = 'none';
					this.customStyle['--user-input-visibility'] = 'block';
					this.updateStyles();
				} else {
					this.customStyle['--loading-visibility'] = 'block';
					this.customStyle['--loading-visibility-margin'] = 'auto';
					this.customStyle['--user-input-visibility'] = 'none';
					this.updateStyles();
				}
			}

			Polymer({
				is: 'onion-settings-bluetooth',
				//created: created,
				ready: ready,
				init: init,
				getState: getState,
				onLoading: onLoading,
				enableBluetoothChanged: enableBluetoothChanged,
				_setAttributeWithoutObserving: _setAttributeWithoutObserving,
				properties: {
					enableBluetooth: {
						type: Boolean,
						notify: true,
						observer: "enableBluetoothChanged"
					}
				}
			});
		})();
	</script>
</dom-module>
