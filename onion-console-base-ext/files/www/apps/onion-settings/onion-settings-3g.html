<link rel="import" href="../../lib/polymer/polymer.html">
<link rel="import" href="../../lib/iron-icons/iron-icons.html">

<dom-module id="onion-settings-3g">
	<style>
		body {
			background-color: #f2f2f2;
			padding-top: 4rem;
			padding-bottom: 4rem;
		}

		.main {
			background-color: #fff;
			border-color: transparent;
			padding: 4rem 2rem;
			margin-bottom: 0;
		}

		.container {
			width: 600px;
			margin: 0 auto;
		}

		.card {
			margin-top: 15px;
			background-color: #fff;
		}
			.card form > .form-group:last-child {
				margin-bottom: 0;
			}

		.loading{
			height: 20px;
			width: 20px;
			margin-left: 15px;
			-webkit-animation: rotation 1s infinite linear;
			-moz-animation: rotation 1s infinite linear;
			-o-animation: rotation 1s infinite linear;
			animation: rotation 1s infinite linear;
			border-left: 3px solid #EAF1FF;
			border-right: 3px solid #EAF1FF;
			border-bottom: 3px solid #EAF1FF;
			border-top: 3px solid #2450AD;
			border-radius: 100%
		}

		@-webkit-keyframes rotation {
			from{
				-webkit-transform: rotate(0deg)
			}
			to{
				-webkit-transform: rotate(359deg)
			}
		}

		@-moz-keyframes rotation {
			from{
				-moz-transform: rotate(0deg)
			}
			to{
				-moz-transform: rotate(359deg)
			}
		}

		@-o-keyframes rotation {
			from{
				-o-transform: rotate(0deg)
			}
			to{
				-o-transform: rotate(359deg)
			}
		}

		@keyframes rotation {
			from{
				transform: rotate(0deg)
			}
			to{
				transform: rotate(359deg)
			}
		}
	</style>

	<template>
		<div class="container">
			<h4 class="card-title">3G modem setup</h4>
			<div class="card card-block">
				<form id="modem-form">
					<!-- removed enabled checkbox for now -- cannot disable ap anyway -->
					<!-- <div class="form-group row"> -->
						<!-- enabled -->
						<!-- <label for="ap-enabled" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Enable AP Mode</label> -->
						<!-- <div class="col-lg-8 col-md-8 col-sm-8 col-xs-8"> -->
							<!-- <div class="checkbox"> -->
								<!-- <label><input type="checkbox" id="enableAP" checked="{{enableAP::change}}" autocomplete="off" /></label> -->
							<!-- </div> -->
						<!-- </div> -->
					<!-- </div> -->

					<fieldset>
						<div class="form-group row">
							<label for="modem-service" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Service</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<select class="form-control c-select" id="modem-service" autocomplete="off" value="{{modemService::input}}">
									<option value="cdma">CDMA</option>
									<option value="evdo">EVDO</option>
									<option value="umts">UMTS</option>
									<option value="umts_only">UMTS only</option>
									<option value="gprs_only">GPRS only</option>
								</select>
							</div>
						</div>
						
						<div class="form-group row">
							<label for="modem-pin-code" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">PIN code</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<input type="text" class="form-control" id="modem-pin-code" autocomplete="off" value="{{modemPinCode::input}}" />
							</div>
						</div>
						
						<div class="form-group row">
							<label for="modem-apn" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">APN</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<input type="text" class="form-control" id="modem-apn" autocomplete="off" value="{{modemApn::input}}" />
							</div>
						</div>
						
						<div class="form-group row">
							<label for="modem-dial-number" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Dial number</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<input type="text" class="form-control" id="modem-dial-number" autocomplete="off" value="{{modemDialNumber::input}}" />
							</div>
						</div>
						
						<div class="form-group row">
							<label for="modem-username" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Username</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<input type="text" class="form-control" id="modem-username" autocomplete="off" value="{{modemUsername::input}}" />
							</div>
						</div>
						
						<div class="form-group row">
							<label for="modem-password" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">Password</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<input type="text" class="form-control" id="modem-password" autocomplete="off" value="{{modemPassword::input}}" />
							</div>
						</div>
						
						<div class="form-group row">
							<label for="modem-options" class="col-lg-4 col-md-4 col-sm-4 col-xs-4 form-control-label">PPPD options</label>
							<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8">
								<input type="text" class="form-control" id="modem-options" autocomplete="off" value="{{modemPppdOptions::input}}" />
							</div>
						</div>
						
					</fieldset>

					<div class="row">
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-lg-offset-4 col-md-offset-4 col-sm-offset-4 col-xs-offset-4">
							<div id="modem-message">{{modemMessage}}</div>
						</div>
					</div>

					<div class="form-group row">
						<div class="col-lg-8 col-md-8 col-sm-8 col-xs-8 col-lg-offset-4 col-md-offset-4 col-sm-offset-4 col-xs-offset-4">
							<div class="layout horizontal center">
								<button id="modem-config-button" type="button" class="btn btn-success" on-click="setupModem">Configure modem</button>
								<div id="configureLoadingModem" class="loading" hidden></div>
							</div>
						</div>
					</div>
				</form>
			</div>
		</div>
	</template>

	<script>
		'use strict';

		(function () {
			// var this = null;

			var created = function () {
				// this = this;
			};

			var ready = function () {
				onionConsole.getService('onion-session-provider', function (err, sessionProvider) {
                    this.sessionProvider = sessionProvider;
	                // if (this.sessionProvider.isAlive() === true) {
	                    onionConsole.getService('onion-3g-provider', function (err, modemProvider) {
	                        this.modemProvider = modemProvider;
						}.bind(this));
	                // };
                }.bind(this));

     //            if (this.sessionProvider.isAlive() === true) {
     //                onionConsole.getService('onion-wifi-provider', function (err, wifiProvider) {
     //                    this.wifiProvider = wifiProvider;
					// });
     //            };

			};

			var init = function () {
				this.refreshConfigInfo();
			};
			
			var refreshConfigInfo = function () {
				var promise = new Promise(function (resolve, reject) {
					this.setLoading(true);

					var getConfigPromise 	= this.modemProvider.getInterfaceConfig(null);

					Promise.all([getConfigPromise])
					.then(function(values) {
						var data = values[0].values;
						this.set('modemService', data.service);
						this.set('modemPinCode', data.pincode);
						this.set('modemApn', data.apn);
						this.set('modemDialNumber', data.dialnumber);
						this.set('modemUsername', data.username);
						this.set('modemPassword', data.password);
						this.set('modemPppdOptions', data.pppd_options);
						// disable the loading
						this.setLoading(false);
						// resolve the promise
						resolve();
					}.bind(this));
				}.bind(this));

				return promise;
			}

			var setLoading = function (bLoading) {
				if (bLoading) {
					this.$.configureLoadingModem.hidden = false;
			    	this.$['modem-config-button'].disabled = true;
				} else {
					this.$.configureLoadingModem.hidden = true;
		    		this.$['modem-config-button'].disabled = false;
				}
			};

			var onAppIcon = function (e) {
				this.onionConsole.launchApp(e.target);
			};
			
			var setupModem = function () {
				this.setLoading(true);
			    this.modemMessage = '';

			    var verifyResult = 'OK';
				if (!this.modemApn || this.modemApn === '') {
					verifyResult = 'Please enter an APN';
				}
				
				if (!this.modemDialNumber || this.modemDialNumber === '') {
					verifyResult = 'Please enter an dial number';
				}
				var propertyList = this.properties;
				var attributes = {};
				for (var attribute in propertyList) {
					attributes[attribute] = this[attribute];
				}
				if (verifyResult === 'OK' && this.sessionProvider.isAlive() === true) {
					this.modemProvider.setInterfaceConfig(null, attributes)
					.then(function () {
						return (this.refreshConfigInfo());
					}.bind(this))
					.then(function () {
						this.setLoading(false);
						onionConsole.sendNotification({
							title: 'Success',
							message: 'Changes were applied!'
						});
					}.bind(this))
		        	.catch(function (err) {
						this.setLoading(false);
		        		onionConsole.sendNotification({
							title: 'Error',
							message: err
						});
		        	}.bind(this));
				} else {
				    this.modemMessage = verifyResult;
					this.setLoading(false);
				}
			}

			Polymer({
				is: 'onion-settings-3g',
				created: created,
				ready: ready,
				init: init,
				setLoading: setLoading,
				refreshConfigInfo: refreshConfigInfo,
				setupModem: setupModem,
				properties: {
					modemService: {
						type: String,
						notify: true
					},
					modemPinCode: {
						type: String,
						notify: true
					},
					modemApn: {
						type: String,
						notify: true
					},
					modemDialNumber: {
						type: String,
						notify: true
					},
					modemUsername: {
						type: String,
						notify: true,
						value: ''
					},
					modemPassword: {
						type: String,
						notify: true,
						value: ''
					},
					modemPppdOptions: {
						type: String,
						notify: true,
						value: ''
					},
				}
			});
		})();
	</script>
</dom-module>
